{% extends "base.html" %}
{% load media %}
{% block title %}N-PACT - N-Profile Analysis Computational Tool{% endblock %}

{% block addScript %}
  {% include_media 'jquery.js' %}
{% endblock addScript %}

{% block content %}
<h2>N-PACT is Running</h2>
<h3>Status</h3>

<div class="contentPadding">
  <span id="computationrunning">The computation is currently running.</span>
  <div id="progressreport">
    <div class="timer"></div>
    <div class="text"> 
      <h4>Current Progress</h4>
      <ul id="steps">
      </ul>
    </div>
  </div>
<script type="text/javascript">
  var progress ={
     url:"{{ path }}",
     dom: jQuery('#progressreport'),
     timerDom: jQuery('#progressreport .timer'),
     steps: jQuery('#steps'),
     start: null,
     updateTimer :function (){
       if(progress.start){
          progress.elapsed = new Date() - progress.start;
          progress.timerDom.html(Math.floor(progress.elapsed/1000) + ' sec.');
       }
     }
  };

  function updateDisplay( data ){
     //{"steps": ['a','b'], "tdiff": 10.32341, "step_desc": "a step description."}
     console.log('Update Progress Display', data);
     if(!data) return;
     for(var i=0; i< data.steps.length; i++) {
        progress.steps.append('<li>' + data.steps[i] + '</li>')
     }
  }
  function onsuccess(data){
     console.log('Progress', data);
     if(data.next=='results'){
       if(progress.interval)window.clearInterval(progress.interval);
       progress.steps.append('<li>Finished! Sending file.</li>');
       window.location = data.url;
     }
     else {
       //data.pt looks has progress data
       updateDisplay(data.pt);
       runRequest();
     }
  }
  function onerror(data){
     $('#computationrunning').remove()
     window.clearInterval(progress.interval);
     progress.timerDom.html('There was an error. You can click refresh to try again or return to the <a href="{% url start %}">start</a>.')
     //window.location = "{% url start %}";

  }
  function runRequest(){
     console.log('Starting Progress Request Chain');
     if(!progress.start) progress.start = new Date();
     jQuery.ajax({
       url: progress.url,
       dataType:'json',
       success:onsuccess,
       error: onerror
     })
  }
  jQuery(document).ready(function(){
    runRequest();
    progress.interval = window.setInterval(progress.updateTimer, 500);
  });
</script>

</div>
{%endblock content %}
